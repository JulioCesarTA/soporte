            ("name", _safe_identifier(cfg["name_field"])),
            ("geojson", _safe_identifier(cfg["geojson_field"])),
        ]
    except ValueError as exc:
        raise ValueError(f"ConfiguraciÃ³n invÃ¡lida de distritos: {exc}") from exc

    select_sql = ", ".join(f"{col} AS {alias}" for alias, col in select_fields)
    sql = f"SELECT {select_sql} FROM {table}"
    if cfg.get("where"):
        sql += f" WHERE {cfg['where']}"

    with connection.cursor() as cursor:
        cursor.execute(sql)
        columns = [col[0] for col in cursor.description]
        rows = [dict(zip(columns, row)) for row in cursor.fetchall()]

    parsed: List[Dict] = []
    for row in rows:
        geojson_text = row.get("geojson")
        try:
            data = json.loads(geojson_text) if geojson_text else {}
            coordinates = data.get("coordinates") or []
        except Exception:
            coordinates = []

        polygons: List[List[Dict[str, float]]] = []
        for polygon in coordinates:
            if not polygon:
                continue
            outer_ring = polygon[0]
            path = []
            for point in outer_ring:
                try:
                    lng, lat = float(point[0]), float(point[1])
                    path.append({"lat": lat, "lng": lng})
                except Exception:
                    continue
            if path:
                polygons.append(path)

        parsed.append(
            {
                "id": row.get("id"),
                "code": row.get("code"),
                "name": row.get("name"),
                "color": _color_for_key(str(row.get("name") or row.get("code") or row.get("id"))),
                "polygons": polygons,
            }
        )
    return parsed


def fetch_heatmap(filters: Dict[str, str] | None = None) -> List[Dict]:
    """Aggregate devices that no se mueven mucho (bounding box <= delta)."""
    filters = filters or {}
    cfg = get_map_config()
    fields = get_filter_fields()
    try:
        table = _safe_identifier(cfg["table"])
        lat = _safe_identifier(cfg["lat_field"])
        lng = _safe_identifier(cfg["lng_field"])
        device = _safe_identifier(fields["device_id"])
    except ValueError as exc:
        raise ValueError(f"ConfiguraciÃ³n invÃ¡lida de heatmap: {exc}") from exc

    clauses, values = _build_filters(filters)
    speed_field = _safe_identifier(fields["speed_level_id"])
    if not filters.get("speed_level_id") and DEFAULT_QUIET_SPEED_LEVEL_ID:
        clauses.append(f"{speed_field} = %s")
        values.append(DEFAULT_QUIET_SPEED_LEVEL_ID)
    clauses.append(f"{lat} IS NOT NULL")
    clauses.append(f"{lng} IS NOT NULL")
    where_sql = " AND ".join(clauses) if clauses else "1=1"

    sql = f"""
    SELECT {device} AS device_id,
           AVG({lat}) AS avg_lat,
           AVG({lng}) AS avg_lng,
           MAX({lat})-MIN({lat}) AS delta_lat,
           MAX({lng})-MIN({lng}) AS delta_lng,
           COUNT(*) AS points
    FROM {table}
    WHERE {where_sql}
    GROUP BY {device}
    HAVING (MAX({lat})-MIN({lat})) <= %s AND (MAX({lng})-MIN({lng})) <= %s
    ORDER BY points DESC
    """
    values.extend([DEFAULT_HEAT_DELTA, DEFAULT_HEAT_DELTA])

    with connection.cursor() as cursor:
        cursor.execute(sql, values)
        rows = cursor.fetchall()

    return [
        {"lat": row[1], "lng": row[2], "count": row[5], "device_id": row[0]}
        for row in rows
    ]


def fetch_filter_options() -> Dict[str, List[Dict]]:
    tables = {
        "moments": ("dim_momento", "momento_id", "momento_dia"),
        "altitude_levels": ("dim_nivel_altitud", "nivel_altitud_id", "nivel_altitud"),
        "signal_levels": ("dim_nivel_senal", "nivel_senal_id", "nivel_senal"),
        "speed_levels": ("dim_nivel_velocidad", "nivel_velocidad_id", "nivel_velocidad"),
        "operators": ("dim_operador", "operador_id", "nombre_operador"),
        "networks": ("dim_red", "red_id", "tipo_red"),
    }
    result: Dict[str, List[Dict]] = {}
    with connection.cursor() as cursor:
        for key, (table, id_field, name_field) in tables.items():
            try:
                cursor.execute(
                    f"SELECT {_safe_identifier(id_field)}, {_safe_identifier(name_field)} FROM {_safe_identifier(table)} ORDER BY 1"
                )
                rows = cursor.fetchall()
                result[key] = [{"id": r[0], "name": r[1]} for r in rows]
            except Exception:
                result[key] = []
    return result
